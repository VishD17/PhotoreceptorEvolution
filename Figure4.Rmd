#Scaling Data
```{r}
#data <- LoadH5Seurat("/Users/vishruthdinesh/Downloads/Ind_Seurat_Objects/CleanIntegratedObject.h5seurat")
OrthoObject4 <- data
OrthoObject4 = ScaleData(OrthoObject4, features = rownames(OrthoObject4))
DefaultAssay(OrthoObject4) = "RNA"
OrthoObject4$seurat_clusters <- sub("oS-cone", "oCone", OrthoObject4$seurat_clusters)
OrthoObject4$seurat_clusters <- sub("oLM-cone", "oCone", OrthoObject4$seurat_clusters)
OrthoObject4$celltype <- sub("s-cone", "Cone", OrthoObject4$celltype)
OrthoObject4$celltype <- sub("l/m-cone", "Cone", OrthoObject4$celltype)
OrthoObject4$celltype <- sub("double-cone", "Cone", OrthoObject4$celltype)
OrthoObject4$celltype <- sub("rod", "Rod", OrthoObject4$celltype)
#Idents(OrthoObject4) = "celltype"
#OrthoObject4 = subset(OrthoObject4, cells = WhichCells(OrthoObject4, downsample = 300, seed = 12345))
OrthoObject4$dendro.order = factor(OrthoObject4$celltype)
table(OrthoObject4$dendro.order)

```

#Dividing Into Phylogenetic Clades + Markers
```{r}
logFC.threshold = 0.5
padj.threshold = 0.05

# Primate DEGs
PrimatePR = subset(OrthoObject4, species %in% c("marmoset", "human"))

PrimatePRMarkers = wilcoxauc(PrimatePR, 'celltype')
#genes_human = rownames(human_ortho)
#genes_marmoset = rownames(marmoset_ortho)
#common_primate_genes <- intersect(genes_human, genes_marmoset)
#PrimatePR = PrimatePR[common_primate_genes,]
#PrimatePRMarkers = wilcoxauc(PrimatePR, 'celltype')

# Rodent DEGs
#RodentPR <- subset(OrthoObject4, species %in% c("mouse", "squirrel"))
RodentPR <- subset(OrthoObject4, species %in% c("mouse", "squirrel"))
RodentPRMarkers = wilcoxauc(RodentPR, 'celltype')

# Laurasiatherian DEGs
LaurasiaPR = subset(OrthoObject4, species %in% c("cow"))
LaurasiaPRMarkers = wilcoxauc(LaurasiaPR, 'celltype')

#Lizard+Chicken
LizChickPR = subset(OrthoObject4, species %in% c("lizard", "chicken"))
LizChickPRMarkers = wilcoxauc(LizChickPR, 'celltype')
```
# Extract top genes
```{r}
Primate_Cone_subset = subset(PrimatePRMarkers, group == "Cone" & logFC > logFC.threshold & padj < padj.threshold) %>% arrange(padj)
Primate_Rod_subset = subset(PrimatePRMarkers, group == "Rod" & logFC > logFC.threshold & padj < padj.threshold) %>% arrange(padj)

PrimateDEGs <- rbind(Primate_Cone_subset, Primate_Rod_subset)


Rodent_Cone_subset = subset(RodentPRMarkers, group == "Cone" & logFC > logFC.threshold & padj < padj.threshold) %>% arrange(padj)
Rodent_Cone_subset1 = subset(RodentPRMarkers, group == "Cone" & logFC > logFC.threshold & padj < padj.threshold) %>% arrange(padj)%>% 
  head(75)
Rodent_Rod_subset = subset(RodentPRMarkers, group == "Rod" & logFC > logFC.threshold & padj < padj.threshold) %>% arrange(padj)
RodentDEGs <- rbind(Rodent_Cone_subset, Rodent_Rod_subset)
RodentDEGs_Vis <- rbind(Rodent_Cone_subset1, Rodent_Rod_subset)



Laurasia_Cone_subset1 = subset(LaurasiaPRMarkers, group == "Cone" & logFC > logFC.threshold & padj < padj.threshold) %>% arrange(padj)%>% head(100)
Laurasia_Cone_subset = subset(LaurasiaPRMarkers, group == "Cone" & logFC > logFC.threshold & padj < padj.threshold) %>% arrange(padj)
Laurasia_Rod_subset = subset(LaurasiaPRMarkers, group == "Rod" & logFC > logFC.threshold & padj < padj.threshold) %>% arrange(padj)
LaurasiaDEGs <- rbind(Laurasia_Cone_subset,  Laurasia_Rod_subset)
LaurasiaDEGs_Vis <- rbind(Laurasia_Cone_subset1,  Laurasia_Rod_subset)

#LizChick_Cone_subset = subset(LizChickPRMarkers, group == "oCone" & logFC > logFC.threshold & padj < padj.threshold) %>% arrange(padj)
#LizChick_Rod = subset(LizChickPRMarkers, group == "oRod" & logFC > logFC.threshold & padj < padj.threshold) %>% arrange(padj)
#LizChickDEGs <- rbind(LizChick_LM_subset, LizChick_S_subset, LizChick_Rod)

# Conserved and species-enriched genes
# Flatten the lists into vectors
PrimateDEGs_flat <- unlist(PrimateDEGs)
RodentDEGs_flat <- unlist(RodentDEGs)
LaurasiaDEGs_flat <- unlist(LaurasiaDEGs)
#LizChickDEGs_flat <- unlist(LizChickDEGs)

# Combine the vectors into a list
shared <- list(PrimateDEGs_flat, RodentDEGs_flat, LaurasiaDEGs_flat)

# Perform intersection on the flattened vectors
sharedDEGs <- Reduce(intersect, shared)


primateSpecificDEGs = lapply(seq_along((levels(OrthoObject4$dendro.order))), function(element){
  speciesDEGs = PrimateDEGs$feature
  return(speciesDEGs[!speciesDEGs %in% c(RodentDEGs_Vis$feature, LaurasiaDEGs_Vis$feature)])
  })
primateSpecificDEGs = primateSpecificDEGs[[1]]

rodentSpecificDEGs = lapply(seq_along((levels(OrthoObject4$dendro.order))), function(element){
  speciesDEGs = RodentDEGs_Vis$feature
  return(speciesDEGs[!speciesDEGs %in% c(PrimateDEGs$feature, LaurasiaDEGs_Vis$feature)])
  })
rodentSpecificDEGs = rodentSpecificDEGs[[1]]

laurasiaSpecificDEGs = lapply(seq_along((levels(OrthoObject4$dendro.order))), function(element){
  speciesDEGs = LaurasiaDEGs_Vis$feature
  return(speciesDEGs[!speciesDEGs %in% c(RodentDEGs_Vis$feature, PrimateDEGs$feature)])
  })
laurasiaSpecificDEGs = laurasiaSpecificDEGs[[1]]

```

```{r}
message("# of shared genes found: ", length(unique(sharedDEGs %>% unlist)))
message("# of shared genes found: ", length(unique(primateSpecificDEGs %>% unlist)))
message("# of shared genes found: ", length(unique(rodentSpecificDEGs %>% unlist)))
message("# of shared genes found: ", length(unique(laurasiaSpecificDEGs %>% unlist)))
```


```{r}
#new_order <- c("oCone", "oRod")
#OrthoObject4$dendro.order <- factor(OrthoObject4$seurat_clusters)
PrimateSubset = subset(PrimatePR, cells = WhichCells(PrimatePR, downsample = 100, seed = 12345))
RodentSubset = subset(RodentPR, cells = WhichCells(RodentPR, downsample = 100, seed = 12345))
RodentSubset = ScaleData(RodentPR, features = rownames(RodentPR))
LaurasiaSubset = subset(LaurasiaPR, cells = WhichCells(LaurasiaPR, downsample = 100, seed = 12345))

panel1 = ConservedEnrichedHeatmap(PrimateSubset, sharedDEGs, primateSpecificDEGs, rodentSpecificDEGs, laurasiaSpecificDEGs,
                                  group.by = "dendro.order", group.bar = FALSE,  draw.lines = FALSE)
panel2 = ConservedEnrichedHeatmap(RodentSubset, sharedDEGs, primateSpecificDEGs, rodentSpecificDEGs, laurasiaSpecificDEGs,
                                  group.by = "dendro.order", group.bar = FALSE,  draw.lines = FALSE)
panel3 = ConservedEnrichedHeatmap(LaurasiaSubset, sharedDEGs, primateSpecificDEGs, rodentSpecificDEGs, laurasiaSpecificDEGs,
                                  group.by = "dendro.order", group.bar = FALSE,  draw.lines = FALSE)

full_panel =  plot_grid(panel1, 
                        panel2, 
                        panel3, 
                        nrow = 3)

full_panel

```

```{r}
panel1 = ConservedEnrichedHeatmap2(PrimateSubset, RodentSubset, LaurasiaSubset, sharedDEGs,
                                   group.by = "dendro.order", group.bar = FALSE, draw.lines = FALSE, color = "magenta")
panel2 = ConservedEnrichedHeatmap2(PrimateSubset, RodentSubset, LaurasiaSubset, primateSpecificDEGs,
                                   group.by = "dendro.order", group.bar = FALSE, draw.lines = FALSE, color = "blue")
panel3 = ConservedEnrichedHeatmap2(PrimateSubset, RodentSubset, LaurasiaSubset, rodentSpecificDEGs,
                                   group.by = "dendro.order", group.bar = FALSE, draw.lines = FALSE, color = "turquoise3")
panel4 = ConservedEnrichedHeatmap2(PrimateSubset, RodentSubset, LaurasiaSubset, laurasiaSpecificDEGs,
                                   group.by = "dendro.order", group.bar = FALSE, draw.lines = FALSE, color = "orange")

full_panel =  plot_grid(panel1,
                        panel2,
                        panel3,
                        panel4,
                        nrow = 4)

full_panel
```

##Figure 4B - Venn Diagrams
```{r}
#types.use = rev(c("Cone", "Rod"))
#OrthoObject4$seurat_clusters <- sub("oCone", "Cone", OrthoObject4$seurat_clusters)
#OrthoObject4$seurat_clusters <- sub("oRod", "Rod", OrthoObject4$seurat_clusters)

# Subset to known types
metadata = Metadata(OrthoObject4, feature.1 = "seurat_clusters", feature.2 = "celltype")
metadata.ordered = metadata[metadata$celltype %in% types.use,] %>% arrange(factor(celltype, levels = types.use))
types.clusters = metadata.ordered$seurat_clusters

types.clusters = "Rod"
```

```{r}

vd_list = lapply(seq_along(types.clusters), function(index){
  cluster = types.clusters[[index]]
  venn.diagram(PrimateDEGs[[cluster]]$feature, RodentDEGs[[cluster]]$feature, LaurasiaDEGs[[cluster]]$feature)
})

vd_list

par(mfrow = c(1,2))
plot(c(1,2,3), c(1,2,4))
plot(c(1,2,3), c(1,2,4))
```

```{r}

# Extract DEGs features from each dataset
primate_genes <- PrimateDEGs$feature
rodent_genes <- RodentDEGs$feature
laurasia_genes <- LaurasiaDEGs$feature

# Create a Venn diagram
venn_plot <- venn.diagram(
  x = list(Primate = primate_genes, Rodent = rodent_genes, Laurasia = laurasia_genes),
  category.names = c("Primate", "Rodent", "Laurasia"),
  filename = NULL,
  output = TRUE
)
grid.draw(venn_plot)
```

```{r}
# Split PrimateDEGs based on cell types 


primate_rod_genes <- PrimateDEGs[PrimateDEGs$group == "Rod", "feature"]
primate_cone_genes <- PrimateDEGs[PrimateDEGs$group == "Cone", "feature"]
rodent_rod_genes <- RodentDEGs[RodentDEGs$group == "Rod", "feature"]
rodent_cone_genes <- RodentDEGs[RodentDEGs$group == "Cone", "feature"]
laurasia_rod_genes <- LaurasiaDEGs[LaurasiaDEGs$group == "Rod", "feature"]
laurasia_cone_genes <- LaurasiaDEGs[LaurasiaDEGs$group == "Cone", "feature"]


# Create Venn diagrams for each cell type
venn_rod <- venn.diagram(
  x = list(Primate = primate_rod_genes, Rodent = rodent_rod_genes, Laurasia = laurasia_rod_genes),
  category.names = c("Primate", "Rodent", "Laurasia"),
  filename = NULL,
  output = TRUE
)

venn_cone <- venn.diagram(
  x = list(Primate = primate_cone_genes, Rodent = rodent_cone_genes, Laurasia = laurasia_cone_genes),
  category.names = c("Primate", "Rodent", "Laurasia"),
  filename = NULL,
  output = TRUE
)


grid.draw(venn_rod)

```




