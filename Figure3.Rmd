```{r}
#Load libraries
library(tidyverse)
library(pals)
## library(ggtree)
library(ape)
library(adephylo)
library(Seurat)

library(ggplot2)
library(ggdendro)
library(cowplot)
library(phylogram)
library(dendextend)
library(circlize)
library(RColorBrewer)
library(viridis)
#library(ggsci)
#library(pvclust)
#library(reshape2)
#library(stats)
```


```{r}
#Figure 3a 
ph <- NormalizeData(ph)
ph <- FindVariableFeatures(ph, nfeatures = 2000)
ph <- ScaleData(ph)
ph <- RunPCA(ph)
ph <- RunUMAP(ph, dims = 1:50)

ph <- FindNeighbors(ph, dims = 1:10)
ph <- FindClusters(ph, resolution = 0.5)
##PRs (No Integration)
DimPlot(ph, group.by = "species")

##PRs (Integrated)
DimPlot(OrthoObject2, group.by = "species")
```

```{r}
# Figure 3b - Marker Gene Feature Plots
FeaturePlot(OrthoObject2, features = "RHO")
FeaturePlot(OrthoObject2, features = c("THRB"))
FeaturePlot(OrthoObject2, features = c("OPN1SW"))
FeaturePlot(OrthoObject2, features = c("CALB1")) #Talk about how CALB1 cannot be applied for other animals and why.

```

```{r}
#Figure 3c - OrthoType Plot
#Merging Seurat Cluster 2 & 3
Idents(OrthoObject2) = "seurat_clusters"
OrthoObject2 <- MergeClusters(OrthoObject2, idents = c(2,3), refactor = TRUE)
#Renaming SeuratClusters to OrthoType identity
OrthoObject2$seurat_clusters <- sub("0", "oLM-cone", OrthoObject2$seurat_clusters)
OrthoObject2$seurat_clusters <- sub("1", "oS-cone", OrthoObject2$seurat_clusters)
OrthoObject2$seurat_clusters <- sub("2", "oRod", OrthoObject2$seurat_clusters)

#Viewing UMAP Plots
DimPlot(OrthoObject2, group.by = "celltype")
DimPlot(OrthoObject2, group.by = "seurat_clusters")
```

```{r}
##3d - Mouse Confusion Matrix
type_table <- table(OrthoObject2@meta.data$species, OrthoObject2@meta.data$seurat_clusters)
mouse_table <- type_table[grep("mou", rownames(type_table)),]

mouse_order <- paste0("mou_",  c("l/m-cone","rod", "s-cone"))
OT_order <- c("oLM-cone", "oRod", "oS-cone")

plotConfusionMatrix(mouse_table[mouse_order, NOG_order], col.high = "darkblue", col.low = "white", xlab.use = "NOG", ylab.use = "Mouse Types")

```


```{r}
#Figure 3e - OrthoType DE genes
rod_markers_OT <- FindMarkers(OrthoObject2, ident.1 = "oRod", ident.2 = NULL, only.pos = TRUE)
head(rod_markers_OT, n = 3)
scone_markers_OT <- FindMarkers(OrthoObject2, ident.1 = "oS-cone", ident.2 = NULL, only.pos = TRUE)
head(scone_markers_OT, n = 3)
lmcone_markers_OT <- FindMarkers(OrthoObject2, ident.1 = "oLM-cone", ident.2 = NULL, only.pos = TRUE)
head(lmcone_markers_OT, n = 3)

markers = c("OPN1SW", "CCDC136", "CDH20","RHO", "GNAT1", "SAG",  "PDE6C", "THRB", "SOX5")

DotPlot(OrthoObject2, features = markers, assay = "RNA", group.by = "seurat_clusters", cols = c("white", "#6e78ff")) + RotatedAxis()
```

```{r}
#Figure 3f
type_table <- table(OrthoObject2@meta.data$species, OrthoObject2@meta.data$seurat_clusters)
type_table = type_table[rowSums(type_table) > 20,]
max_type <- colnames(type_table)[max.col(type_table)]

types_plot <- which(max_type == "oRod")
types_plot <- c(types_plot, which(max_type == "oS-cone"))
types_plot <- rownames(type_table)[types_plot]

OT_order <- c("LM-cone, S-cone, Rod")
plot_table <- type_table[types_plot, OT_order]

plot_table = t(scale(t(plot_table), center = FALSE, scale = rowSums(plot_table))) * 100
df = melt(plot_table)

colnames(df) = c("species", "OT", "mapping")
df$species = factor(df$species, levels = rev(types_plot))
df$seurat_clusters = factor(df$seurat_clusters, levels = OT_order)


```

```{r}
OrthoObject2@meta.data$species_class <- paste0(OrthoObject2@meta.data$species, "_", OrthoObject2@meta.data$celltype)
Idents(OrthoObject2) <- "species_class"
type_table <- table(OrthoObject2@meta.data$species_class, OrthoObject2@meta.data$seurat_clusters)
types_plot <- grep("chi", rownames(type_table), value = TRUE)
chicken_table <- type_table[types_plot,]

OT_order <- c("oLM-cone", "oRod", "oS-cone")
type_order = c("chicken_l/m-cone", "chicken_rod", "chicken_s-cone", "chicken_double-cone")

plotConfusionMatrix(chicken_table[type_order, OT_order], col.high = "darkblue", col.low = "white", xlab.use = "OT", ylab.use = "Cow Types")
dev.off()

```



